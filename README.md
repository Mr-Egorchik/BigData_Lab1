# BigData, Лабораторная работа 1

## Читоркин Егор, группа 6133-010402D

В ходе лабораторной работы был выполнен ряд заданий по исследованию данных о поездках на велосипедах и станциях. Все запросы выполнялись посредством библиотеки pyspark.

Для начала были считаны csv-файлы с данными, после были созданы классы для хранения этих данных, и, наконец, с помощью метода mapPartitions() данные были преобразованы в объекты созданных классов.

### 1. Найти велосипед с максимальным временем пробега

Для выполнения данного задания сначала был осуществлен маппинг существующих объектов в пары (bike_id, duration), так как нам необходим только id велосипеда и время поездки. Далее была осуществлена операция редукции + по ключу bike_id, тем самым найдено общее время пробега каждого велосипеда.

```python
run_bicycles = tripsInternal\
  .map(lambda trip: (trip.bike_id, trip.duration))\
  .reduceByKey(lambda a, b: a + b)
```

Далее с целью нахождения велосипеда с наибольшим пробегом был вызван метод top(), где в качестве ключа выступает общий пробег, т.е. элемент с индексом 1 в кортежах, полученных посредством маппинга.

```python
top_bicycle = run_bicycles.top(1, key=lambda x: x[1])[0]
```

В результате получаем вывод:

> bike_id:	535 \
> duration:	18611693

### 2. Найти наибольшее геодезическое расстояние между станциями

Так как для нахождения наибольшего расстояния между станциями нам необходимо знать все расстояния между каждой парой станций, то сначала составим декартов квадрат множества станций с помощью метода cartesian. Далее произведем маппинг, чтобы оставить необходимые данные: id станций и расстояние между ними (функция dist реализована отдельно)

```python
all_distances = stationsInternal\
  .cartesian(stationsInternal)\
  .map(lambda pair: (pair[0].station_id, pair[1].station_id, dist(pair[0], pair[1])))
```

Далее с помощью метода top(), как и в прошлом задании, получаем наибольшее значение расстояния и соответствующую пару станций.

> Max distance:	0.7058482821754397 \
> Stations:	16-60

### 3. Найти путь велосипеда с максимальным временем пробега через станции

Так как велосипед с максимальным пробегом мы нашли в задании 1, то проведем фильтрацию набора поездок, оставив только те, у которых bike_id совпадает с bike_id этого велосипеда. Далее првоедем сортировку по start_date, чтобы хронологический восстановить маршрут.

```python
points_of_way = tripsInternal\
  .filter(lambda trip: trip.bike_id == top_bicycle[0])\
  .sortBy(lambda trip: trip.start_date)
```

Далее с помощью метода take() выведем несколько первых элементов маршрута.

> Dates:	2013-08-29 19:32:00 ~ 2013-08-29 19:53:00	Way:	47-70\
> Dates:	2013-08-29 21:38:00 ~ 2013-08-29 21:45:00	Way:	70-69\
> Dates:	2013-08-30 08:40:00 ~ 2013-08-30 08:54:00	Way:	69-77\
> Dates:	2013-08-30 09:10:00 ~ 2013-08-30 09:19:00	Way:	77-64\
> Dates:	2013-09-01 12:58:00 ~ 2013-09-01 13:26:00	Way:	61-42

### 4. Найти количество велосипедов в системе

Для начала проведем маппинг, чтобы оставить только bike_id, так как для подсчета количества велосипедов иные данные не нужны. Далее методом distinct оставим только уникальные значения bike_id (так как в наборе данных много дубликатов, ведь один велосипед участвет во многих поездках). После этого методом count() найдем их количество.

```python
bikes_count = tripsInternal\
  .map(lambda trip: trip.bike_id)\
  .distinct()\
  .count()
```

Получим следующий вывод:

> Bikes count:	 700

### 5. Найти пользователей потративших на поездки более 3 часов

Для начала проведем маппинг, чтобы оставить только zip_code (id пользователя) и duration (длительность поездки в секундах). Далее проведем редукцию, просуммировав все длительности по ключу zip_code. В итоге получим общую длительность всех поездок для каждого пользователя. Далее фильттруем с помощью метода filter() те записи, у которых длительность более 3 часов (10800 с).

```python
all_users = tripsInternal\
  .map(lambda trip: (trip.zip_code, trip.duration))\
  .reduceByKey(lambda a, b: a + b)\
  .filter(lambda trip: trip[1] > 10800)
```

Выведем в консоль несколько элементов результата.

> User:	94102	Time:	5313.3h\
> User:	95113	Time:	828.2h\
> User:	94124	Time:	500.1h\
> User:	94111	Time:	3956.9h\
> User:	94114	Time:	1190.5h\
> User:	94403	Time:	1301.8h\
> User:	30324	Time:	18.5h\
> User:	94133	Time:	6010.5h\
> User:	94108	Time:	1424.3h\
> User:	94306	Time:	1541.8h\






